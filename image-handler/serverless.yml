service: image-handler
frameworkVersion: '2'
plugins:
 - serverless-apigw-binary
custom:
  stage: ${opt:stage, self:provider.stage}
  apigwBinary:
    types:
      - 'image/jpeg'
provider:
  name: aws
  runtime: nodejs12.x
  lambdaHashingVersion: 20201221
  apiGateway:
    shouldStartNameWithService: true

functions:
  upload:
    handler: handler.upload
    environment:
      IMAGES_BUCKET: ${ssm:${self:custom.stage}-images-bucket}
    role: ${ssm:${self:custom.stage}-upload-role}
    events:
     - http:
         path: images
         method: post

  download:
    handler: handler.download
    environment:
      IMAGES_BUCKET: ${ssm:${self:custom.stage}-images-bucket}
    role: ${ssm:${self:custom.stage}-download-role}
    events:
     - http:
         path: images/{id}
         method: get
         request: 
          parameters: 
             paths: 
               id: true
